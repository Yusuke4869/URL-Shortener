# リファクタリング指針

## 概要

このドキュメントは、既存システムの改善・再設計を行う際の指針を定義します。
保守性、拡張性、型安全性を向上させるための体系的なアプローチにより、品質の高いコードベースを実現します。

## 基本原則

### 責務分離の実現

**What**: 単一の大きなクラスや関数を、明確な責務ごとに分離する

**Why**:

- 単一責任の原則の実現
- 理解しやすさの向上
- テスタビリティの向上
- 変更の影響範囲の限定

**実施指針**:

- 各コンポーネントが単一の明確な責任を持つ
- 機能ごとに独立したファイル・クラスに分離
- 依存関係を明示的かつ最小限に保つ
- 関心事の境界を明確に定義

### 型安全性の向上

**What**: TypeScript の型システムを最大限活用し、実行時エラーを防ぐ

**Why**:

- バグの早期発見
- リファクタリングの安全性
- 開発効率の向上
- コードの意図の明確化

**実施指針**:

- `as` による型キャストを排除
- union 型を活用した明示的な型定義
- インターフェースによる構造化
- 型ガードの適切な使用

### 簡潔性の追求

**What**: 不要な複雑さを排除し、理解しやすい実装を採用

**Why**:

- 認知負荷の軽減
- 保守コストの削減
- バグの発生率低下
- 新しいメンバーの理解促進

**実施指針**:

- 過度な抽象化を避けて理解しやすさを重視
- 中間レイヤーの必要性を慎重に判断
- 直接的で分かりやすい実装を優先

## リファクタリング手法

### 段階的アプローチ

**What**: 大規模な変更を小さな段階に分けて実施

**Why**:

- リスクの最小化
- 各段階での検証が可能
- 継続的な動作確認
- チームメンバーとの認識合わせ

**実施手順**:

1. 現状の問題分析と改善目標の設定
2. 小さな単位での改善計画立案
3. 段階的な実装と検証
4. 各段階での動作確認とテスト

### 依存関係の整理

**What**: モジュール間の依存関係を明確化し、結合度を下げる

**Why**:

- 変更の影響範囲の限定
- テストの容易さ
- 再利用性の向上
- システム全体の理解しやすさ

**実施指針**:

- 循環依存の排除
- インターフェースによる抽象化
- 依存関係の方向の統一
- 不要な依存関係の削除

## 関数設計の改善

### 純粋関数の活用

**What**: 副作用を持たない関数を積極的に使用

**Why**:

- テストの容易さ
- 予測可能な動作
- 並行処理での安全性
- デバッグの簡素化

**実施指針**:

- ユーティリティ関数は純粋関数として実装
- 外部状態への依存を最小限に
- 引数と戻り値による明示的なデータフロー
- 副作用のある処理は明確に分離

### アロー関数の統一

**What**: クラス以外の関数をアロー関数に統一

**Why**:

- 関数型プログラミングの一貫性
- モダンな JavaScript/TypeScript 記法
- より簡潔な構文
- コードスタイルの統一

**実施指針**:

- `export const functionName = () =>` 形式を採用
- async 関数は `const functionName = async () =>` 形式
- 内部関数も同様にアロー関数を使用
- クラスメソッドは従来の記法を維持

## データ構造の改善

### 型安全なデータフロー

**What**: データの受け渡しを型安全に設計

**Why**:

- 実行時エラーの防止
- データ変換の明示化
- インターフェース契約の明確化
- バグの早期発見

**実施指針**:

- 関数引数での明示的な型定義
- 戻り値の型注釈
- インターフェースによるデータ構造の定義
- optional と required の適切な使い分け

### 不変性の確保

**What**: データの不変性を保つ設計

**Why**:

- 予期しない変更の防止
- 並行処理での安全性
- デバッグの簡素化
- 関数型プログラミングの原則

**実施指針**:

- `const` による変数宣言
- `readonly` プロパティの使用
- オブジェクトの不変性を保つ操作
- 破壊的変更を避ける実装

## 品質確認

### リファクタリング後の検証

**What**: 改善されたコードの品質と動作の確認

**Why**:

- 期待した改善効果の確認
- 新たな問題の早期発見
- チーム全体の理解促進
- 継続的改善のフィードバック

**検証項目**:

- 型チェックの通過
- 既存テストの通過
- パフォーマンスの確認
- 可読性の向上
- 保守性の向上

## リファクタリング品質チェックリスト

新しいリファクタリング実施時の確認事項：

### 計画と設計

- [ ] リファクタリングの目的と範囲が明確である
- [ ] 段階的なアプローチで計画されている
- [ ] 既存の動作を維持する方針が決まっている
- [ ] 型安全性の向上が考慮されている
- [ ] 簡潔性と理解しやすさが重視されている

### 責務分離

- [ ] 単一責任の原則が適用されている
- [ ] 各コンポーネントの責務が明確である
- [ ] 機能ごとの適切な分離ができている
- [ ] 依存関係が最小限に整理されている

### 型安全性

- [ ] `as` による型キャストを排除している
- [ ] union 型を活用した明示的な型定義がある
- [ ] インターフェースによる構造化ができている
- [ ] 型ガードが適切に使用されている

### 関数設計

- [ ] 純粋関数が積極的に活用されている
- [ ] アロー関数が統一されている（クラス以外）
- [ ] 副作用が明確に分離されている
- [ ] 関数の責任が単一かつ明確である

### データ構造

- [ ] 型安全なデータフローが実現されている
- [ ] 不変性が適切に確保されている
- [ ] インターフェース契約が明確に定義されている
- [ ] optional と required が適切に使い分けられている

### 品質確認

- [ ] 全ての型チェックが通過している
- [ ] 既存テストが全て通過している
- [ ] 新たなテストが必要に応じて追加されている
- [ ] パフォーマンスが維持または改善されている
- [ ] 可読性と保守性が向上している
- [ ] ドキュメントが更新されている
